{% extends "base.html" %}
{% block title %}Analytics{% endblock %}

{% block body %}
<div class="container mt-4">
    <h2>Transaction Analytics (Last 90 Days)</h2>

    <div class="row">
        <div class="col-md-3">
            <div class="card text-white bg-success mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total Earned (Sales)</h5>
                    <p class="card-text">$ {{ total_earned }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total Deposits</h5>
                    <p class="card-text">$ {{ total_deposits }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total Withdrawals</h5>
                    <p class="card-text">$ {{ total_withdrawals }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger mb-3">
                <div class="card-body">
                    <h5 class="card-title">Total Spent (Purchases)</h5>
                    <p class="card-text">$ {{ total_spent }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Net Balance Change -->
    <div class="card text-white bg-primary mb-4">
        <div class="card-body">
            <h5 class="card-title">Net Balance Change</h5>
            <p class="card-text">$ {{ net_balance_change }}</p>
        </div>
    </div>

    <!-- Balance Trend Chart -->
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Balance Fluctuations (Last 90 Days)</h5>
            <canvas id="balanceChart"></canvas>
        </div>
    </div>

    <!-- Highest Earnings and Spending Days -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card border-success">
                <div class="card-body">
                    <h5 class="card-title">Highest Earning Day</h5>
                    <p class="card-text">
                        Date: {{ highest_earning_day.date }} <br>
                        Amount: ${{ highest_earning_day.amount }}
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-danger">
                <div class="card-body">
                    <h5 class="card-title">Highest Spending Day</h5>
                    <p class="card-text">
                        Date: {{ highest_spending_day.date }} <br>
                        Amount: ${{ highest_spending_day.amount }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Transactions Table -->
    <div class="card mt-4">
        <div class="card-body">
            <h5 class="card-title">Recent Transactions (Last 90 Days)</h5>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Type</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in transactions %}
                    <tr>
                        <td>{{ transaction.created_at.date }}</td>
                        <td>$ {{ transaction.amount }}</td>
                        <td>
                            {% if transaction.transaction_type == "deposit" %}
                                <span class="badge bg-info">Deposit</span>
                            {% elif transaction.transaction_type == "withdraw" %}
                                <span class="badge bg-warning">Withdraw</span>
                            {% elif transaction.transaction_type == "buy" %}
                                {% if transaction.user_from == request.user %}
                                    <span class="badge bg-danger">Purchase</span>
                                {% elif transaction.user_to == request.user %}
                                    <span class="badge bg-success">Sale</span>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3">No transactions in the last 90 days.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Chart.js for Balance Trend Visualization -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    var ctx = document.getElementById('balanceChart').getContext('2d');
    var balanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [{% for date, balance in balance_chart_data %}"{{ date }}",{% endfor %}],
            datasets: [{
                label: 'Daily Balance Change ($)',
                data: [{% for date, balance in balance_chart_data %}{{ balance }},{% endfor %}],
                borderColor: 'rgba(54, 162, 235, 1)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderWidth: 2,
                tension: 0.3
            }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
</script>
{% endblock %}
